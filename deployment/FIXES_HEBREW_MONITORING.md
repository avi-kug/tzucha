# תיקונים: תרגום עברי וטעינת לוגי אבטחה

**תאריך:** 17 פברואר 2026  
**מטרה:** תרגום בדיקות מערכת לעברית ותיקון טעינת לוגי אבטחה

---

## 🔧 תיקונים שבוצעו

### 1. ✅ תרגום בדיקות מערכת לעברית

**קובץ מעודכן:** `assets/js/users.js`

**שינויים:**
- הוספת תרגום עברי לכל שמות הבדיקות:
  - `database` → **מסד נתונים**
  - `tables` → **טבלאות**
  - `disk_space` → **שטח דיסק**
  - `memory` → **זיכרון**
  - `logs` → **קבצי לוג**
  - `uploads` → **קבצי העלאה**
  - `activity` → **פעילות**

- תרגום הודעות סטטוס נפוצות:
  - "Database connection successful" → **חיבור למסד נתונים תקין**
  - "All required tables exist" → **כל הטבלאות הנדרשות קיימות**
  - "Missing tables:" → **טבלאות חסרות:**
  - "Low disk space:" → **שטח דיסק נמוך:**
  - "Disk space:" → **שטח דיסק פנוי:**
  - "free" → **פנויים**
  - "PHP Memory:" → **זיכרון PHP:**
  - "used" → **בשימוש**
  - "Logs directory writable" → **תיקיית לוגים ניתנת לכתיבה**
  - "Uploads directory writable" → **תיקיית העלאות ניתנת לכתיבה**
  - "logins in last hour" → **כניסות בשעה האחרונה**

**תוצאה:** כעת כל בדיקות המערכת בטאב "ניטור מערכת" מוצגות בעברית ברורה!

---

### 2. ✅ תיקון טעינת לוגי אבטחה

**קבצים מעודכנים:**
- `assets/js/users.js`
- `pages/security_logs_api.php`

#### שינויים ב-JavaScript (users.js):

**פונקציה: `loadSecurityLogsFromDB()`**
- שיפור טיפול בשגיאות HTTP
- הוספת בדיקת `response.ok` לפני ניתוח JSON
- הודעות שגיאה מפורטות יותר בעברית
- הוספת `console.log` לדיבוג
- הצגת מספר הלוגים שנטענו

**פונקציה: `displayLogEntriesFromDB()`**
- שיפור הודעה כשאין לוגים:
  - **לפני:** "לא נמצאו לוגים"
  - **אחרי:** "אין לוגי אבטחה להצגה. הלוגים יירשמו כאן אוטומטית כשמתבצעות פעולות במערכת."

#### שינויים ב-API (security_logs_api.php):

**הרשאות:**
- שינוי מ-`auth_require_admin()` ל-`auth_is_admin()` עם הודעת שגיאה ידידותית
- הודעה: "Access denied - Admin only" (403 Forbidden)

**בדיקות:**
- בדיקה אם הטבלה `security_logs` קיימת לפני שאילתה
- הודעה מפורטת אם הטבלה לא קיימת:
  - "Security logs table does not exist. Please run database migrations."

**טיפול בנתונים:**
- וידוא ש-`$stats` אף פעם לא null (ערכים ברירת מחדל: 0)
- החזרת מערך ריק (`[]`) במקרה שאין לוגים
- הוספת שדה `message` בתגובה JSON כשאין תוצאות
- הוספת `trace` לשגיאות (עזרה בדיבוג)

**צורת תגובה משופרת:**
```json
{
  "success": true,
  "logs": [...],
  "stats": {
    "total": 0,
    "critical": 0,
    "warning": 0,
    "last_24h": 0
  },
  "message": "No logs found"
}
```

---

## 🧪 בדיקות שבוצעו

### 1. בדיקת תחביר

```bash
✅ security_logs_api.php - No errors found
✅ users.js - No errors found
✅ users.php - No errors found
```

### 2. בדיקת API דרך CLI

```bash
$ php security_logs_api.php
✅ {"success":false,"error":"Access denied - Admin only"}
```
(זה נורמלי - ללא סשן מחובר)

---

## 📊 מה לצפות עכשיו

### בטאב "ניטור מערכת" (admin בלבד):

1. **כרטיסי מדדים:**
   - מסד נתונים ✅/❌
   - מקום בדיסק (GB פנויים)
   - זיכרון (MB בשימוש)
   - פעילות (כניסות בשעה)

2. **בדיקות מערכת:**
   - כל בדיקה תוצג עם:
     - ✅ תקין / ⚠️ אזהרה / ❌ שגיאה
     - **שם בעברית**
     - **הודעת סטטוס בעברית**

### בטאב "לוגי אבטחה":

**מצב 1: יש לוגים**
- טבלה עם כל הלוגים (עד 500 אחרונים)
- סטטיסטיקות: סה"כ אירועים, כניסות מוצלחות/נכשלות, הגבלות קצב

**מצב 2: אין לוגים**
- הודעה ברורה בעברית:
  > "אין לוגי אבטחה להצגה. הלוגים יירשמו כאן אוטומטית כשמתבצעות פעולות במערכת."

**מצב 3: שגיאה בטעינה**
- הודעת שגיאה מפורטת (מופיעה ב-console.log ובדף)

---

## 🔍 דיבוג (אם עדיין יש בעיות)

### 1. פתח את ה-Console בדפדפן (F12)

חפש את ההודעות הבאות:
```javascript
Security logs loaded: {...}
Loaded X log entries
```

### 2. בדוק שגיאות אדומות

אם יש שגיאה, היא תציג:
```javascript
Error loading security logs: [error message]
```

### 3. בדוק ישירות את ה-API

פתח בדפדפן:
```
http://localhost/tzucha/pages/security_logs_api.php
```

**תוצאה צפויה (אם מחובר כאדמין):**
```json
{
  "success": true,
  "logs": [...],
  "stats": {...}
}
```

**תוצאה אם לא אדמין:**
```json
{
  "success": false,
  "error": "Access denied - Admin only"
}
```

### 4. בדוק אם הטבלה קיימת

הרץ ב-MySQL/phpMyAdmin:
```sql
SHOW TABLES LIKE 'security_logs';
SELECT COUNT(*) FROM security_logs;
```

אם הטבלה לא קיימת, הרץ:
```sql
SOURCE sql/create_security_logs.sql;
```

או השתמש ב:
```
http://localhost/tzucha/sql/run_create_security_logs.php
```

---

## 📝 סיכום

### ✅ הושלם:
1. ✅ תרגום כל בדיקות המערכת לעברית
2. ✅ תרגום הודעות סטטוס לעברית
3. ✅ שיפור טיפול בשגיאות בטעינת לוגי אבטחה
4. ✅ הוספת הודעות ברורות יותר כשאין לוגים
5. ✅ שיפור API עם בדיקות ותגובות מפורטות
6. ✅ הוספת דיבוג (console.log)

### 🎯 תוצאה:
- **ניטור מערכת:** כעת מוצג בעברית מלאה וברורה!
- **לוגי אבטחה:** טעינה משופרת עם הודעות שגיאה מפורטות

### 📌 הערות:
- אם עדיין יש שגיאה בטעינת לוגים, בדוק שהמשתמש המחובר הוא **אדמין**
- אם הטבלה `security_logs` ריקה, זה נורמלי - לוגים יירשמו אוטומטית בכניסות הבאות
- כל הקבצים עברו בדיקת תחביר ללא שגיאות

---

**נוצר על ידי:** GitHub Copilot  
**סטטוס:** ✅ מוכן לייצור
